/* Generated by tradukisto - do not edit manually */

import type { Json, PostgresClient } from "tradukisto";

export interface INotificationDisplays {
  _id: string;
  type: string;
  link: string | null;
  viewed: boolean;
  message: string;
  createdAt: Date | null;
  extraData: Json | null;
  tagRelId: string | null;
  post: {
    _id: string | null;
    slug: string | null;
    title: string | null;
    draft: boolean | null;
    url: string | null;
    isEvent: boolean | null;
    startTime: Date | null;
    curatedDate: Date | null;
    postedAt: Date | null;
    groupId: string | null;
    fmCrosspost: Json | null;
    collabEditorDialogue: boolean | null;
    readTimeMinutesOverride: number | null;
    wordCount: number | null;
    socialPreviewData: {
      imageUrl: string | null;
    };
    customHighlight: Json | null;
    contents: {
      html: string | null;
      wordCount: number | null;
      originalContents: Json | null;
      editedAt: Date | null;
      userId: string | null;
      version: string | null;
    } | null;
    rsvps: Json[] | null;
    user: {
      _id: string | null;
      slug: string | null;
      createdAt: Date | null;
      displayName: string | null;
      profileImageId: string | null;
      karma: number | null;
      deleted: boolean | null;
      htmlBio: string;
      postCount: number | null;
      commentCount: number | null;
    } | null;
    group: {
      _id: string | null;
      name: string | null;
    } | null;
  } | null;
  comment: {
    _id: string | null;
    user: {
      _id: string | null;
      slug: string | null;
      createdAt: Date | null;
      displayName: string | null;
      profileImageId: string | null;
      karma: number | null;
      deleted: boolean | null;
      htmlBio: string;
      postCount: number | null;
      commentCount: number | null;
    } | null;
    post: {
      _id: string | null;
      slug: string | null;
      title: string | null;
      draft: boolean | null;
      url: string | null;
      isEvent: boolean | null;
      startTime: Date | null;
      curatedDate: Date | null;
      postedAt: Date | null;
      groupId: string | null;
      fmCrosspost: Json | null;
      collabEditorDialogue: boolean | null;
      readTimeMinutesOverride: number | null;
      wordCount: number | null;
      socialPreviewData: {
        imageUrl: string | null;
      };
      customHighlight: Json | null;
      contents: {
        html: string | null;
        wordCount: number | null;
        originalContents: Json | null;
        editedAt: Date | null;
        userId: string | null;
        version: string | null;
      } | null;
      rsvps: Json[] | null;
      user: {
        _id: string | null;
        slug: string | null;
        createdAt: Date | null;
        displayName: string | null;
        profileImageId: string | null;
        karma: number | null;
        deleted: boolean | null;
        htmlBio: string;
        postCount: number | null;
        commentCount: number | null;
      } | null;
      group: {
        _id: string | null;
        name: string | null;
      } | null;
    } | null;
  } | null;
  tag: {
    _id: string | null;
    name: string | null;
    slug: string | null;
  } | null;
  sequence: {
    _id: string | null;
    title: string | null;
  } | null;
  user: {
    _id: string | null;
    slug: string | null;
    createdAt: Date | null;
    displayName: string | null;
    profileImageId: string | null;
    karma: number | null;
    deleted: boolean | null;
    htmlBio: string;
    postCount: number | null;
    commentCount: number | null;
  } | null;
  localgroup: {
    _id: string | null;
    name: string | null;
  } | null;
}

export interface INotificationDisplaysParams {
  postSocialPreviewPrefix: string;
  userId: string;
  type?: string | null;
  limit: number;
  offset: number;
}

export const notificationDisplaysSql = `-- Notifications.notificationDisplays
SELECT "n"."_id", "n"."type", "n"."link", "n"."viewed", "n"."message", "n"."createdAt", "n"."extraData", "tr"."_id" AS "tagRelId", COALESCE(CASE WHEN "p"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "p"."_id", 'slug', "p"."slug", 'title', "p"."title", 'draft', "p"."draft", 'url', "p"."url", 'isEvent', "p"."isEvent", 'startTime', "p"."startTime", 'curatedDate', "p"."curatedDate", 'postedAt', "p"."postedAt", 'groupId', "p"."groupId", 'fmCrosspost', "p"."fmCrosspost", 'collabEditorDialogue', "p"."collabEditorDialogue", 'readTimeMinutesOverride', "p"."readTimeMinutesOverride", 'wordCount', "pr"."wordCount", 'socialPreviewData', JSON_BUILD_OBJECT('imageUrl', CASE WHEN "p"."isEvent" AND "p"."eventImageId" IS NOT NULL THEN $1::TEXT || "p"."eventImageId" WHEN "p"."socialPreview" ->> 'imageId' IS NOT NULL THEN $1::TEXT || ("p"."socialPreview" ->> 'imageId') ELSE COALESCE("p"."socialPreviewImageAutoUrl", '') END), 'customHighlight', "p"."customHighlight", 'contents', CASE WHEN "pr"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('html', "pr"."html", 'wordCount', "pr"."wordCount", 'originalContents', "pr"."originalContents", 'editedAt', "pr"."editedAt", 'userId', "pr"."userId", 'version', "pr"."version") END, 'rsvps', "p"."rsvps", 'user', CASE WHEN "pu"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "pu"."_id", 'slug', "pu"."slug", 'createdAt', "pu"."createdAt", 'displayName', "pu"."displayName", 'profileImageId', "pu"."profileImageId", 'karma', "pu"."karma", 'deleted', "pu"."deleted", 'htmlBio', COALESCE("pu"."biography" ->> 'html', ''), 'postCount', "pu"."postCount", 'commentCount', "pu"."commentCount") END, 'group', CASE WHEN "pl"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "pl"."_id", 'name', "pl"."name") END) END, CASE WHEN "trp"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "trp"."_id", 'slug', "trp"."slug", 'title', "trp"."title", 'draft', "trp"."draft", 'url', "trp"."url", 'isEvent', "trp"."isEvent", 'startTime', "trp"."startTime", 'curatedDate', "trp"."curatedDate", 'postedAt', "trp"."postedAt", 'groupId', "trp"."groupId", 'fmCrosspost', "trp"."fmCrosspost", 'collabEditorDialogue', "trp"."collabEditorDialogue", 'readTimeMinutesOverride', "trp"."readTimeMinutesOverride", 'wordCount', "trpr"."wordCount", 'socialPreviewData', JSON_BUILD_OBJECT('imageUrl', CASE WHEN "trp"."isEvent" AND "trp"."eventImageId" IS NOT NULL THEN $1::TEXT || "trp"."eventImageId" WHEN "trp"."socialPreview" ->> 'imageId' IS NOT NULL THEN $1::TEXT || ("trp"."socialPreview" ->> 'imageId') ELSE COALESCE("trp"."socialPreviewImageAutoUrl", '') END), 'customHighlight', "trp"."customHighlight", 'contents', CASE WHEN "trpr"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('html', "trpr"."html", 'wordCount', "trpr"."wordCount", 'originalContents', "trpr"."originalContents", 'editedAt', "trpr"."editedAt", 'userId', "trpr"."userId", 'version', "trpr"."version") END, 'rsvps', "trp"."rsvps", 'user', CASE WHEN "trpu"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "trpu"."_id", 'slug', "trpu"."slug", 'createdAt', "trpu"."createdAt", 'displayName', "trpu"."displayName", 'profileImageId', "trpu"."profileImageId", 'karma', "trpu"."karma", 'deleted', "trpu"."deleted", 'htmlBio', COALESCE("trpu"."biography" ->> 'html', ''), 'postCount', "trpu"."postCount", 'commentCount', "trpu"."commentCount") END, 'group', CASE WHEN "trpl"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "trpl"."_id", 'name', "trpl"."name") END) END) AS "post", CASE WHEN "c"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "c"."_id", 'user', CASE WHEN "cu"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "cu"."_id", 'slug', "cu"."slug", 'createdAt', "cu"."createdAt", 'displayName', "cu"."displayName", 'profileImageId', "cu"."profileImageId", 'karma', "cu"."karma", 'deleted', "cu"."deleted", 'htmlBio', COALESCE("cu"."biography" ->> 'html', ''), 'postCount', "cu"."postCount", 'commentCount', "cu"."commentCount") END, 'post', CASE WHEN "cp"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "cp"."_id", 'slug', "cp"."slug", 'title', "cp"."title", 'draft', "cp"."draft", 'url', "cp"."url", 'isEvent', "cp"."isEvent", 'startTime', "cp"."startTime", 'curatedDate', "cp"."curatedDate", 'postedAt', "cp"."postedAt", 'groupId', "cp"."groupId", 'fmCrosspost', "cp"."fmCrosspost", 'collabEditorDialogue', "cp"."collabEditorDialogue", 'readTimeMinutesOverride', "cp"."readTimeMinutesOverride", 'wordCount', "cpr"."wordCount", 'socialPreviewData', JSON_BUILD_OBJECT('imageUrl', CASE WHEN "cp"."isEvent" AND "cp"."eventImageId" IS NOT NULL THEN $1::TEXT || "cp"."eventImageId" WHEN "cp"."socialPreview" ->> 'imageId' IS NOT NULL THEN $1::TEXT || ("cp"."socialPreview" ->> 'imageId') ELSE COALESCE("cp"."socialPreviewImageAutoUrl", '') END), 'customHighlight', "cp"."customHighlight", 'contents', CASE WHEN "cpr"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('html', "cpr"."html", 'wordCount', "cpr"."wordCount", 'originalContents', "cpr"."originalContents", 'editedAt', "cpr"."editedAt", 'userId', "cpr"."userId", 'version', "cpr"."version") END, 'rsvps', "cp"."rsvps", 'user', CASE WHEN "cpu"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "cpu"."_id", 'slug', "cpu"."slug", 'createdAt', "cpu"."createdAt", 'displayName', "cpu"."displayName", 'profileImageId', "cpu"."profileImageId", 'karma', "cpu"."karma", 'deleted', "cpu"."deleted", 'htmlBio', COALESCE("cpu"."biography" ->> 'html', ''), 'postCount', "cpu"."postCount", 'commentCount', "cpu"."commentCount") END, 'group', CASE WHEN "cpl"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "cpl"."_id", 'name', "cpl"."name") END) END) END AS "comment", CASE WHEN "t"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "t"."_id", 'name', "t"."name", 'slug', "t"."slug") END AS "tag", CASE WHEN "s"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "s"."_id", 'title', "s"."title") END AS "sequence", COALESCE(CASE WHEN "nma"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "nma"."_id", 'slug', "nma"."slug", 'createdAt', "nma"."createdAt", 'displayName', "nma"."displayName", 'profileImageId', "nma"."profileImageId", 'karma', "nma"."karma", 'deleted', "nma"."deleted", 'htmlBio', COALESCE("nma"."biography" ->> 'html', ''), 'postCount', "nma"."postCount", 'commentCount', "nma"."commentCount") END, CASE WHEN "u"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "u"."_id", 'slug', "u"."slug", 'createdAt', "u"."createdAt", 'displayName', "u"."displayName", 'profileImageId', "u"."profileImageId", 'karma', "u"."karma", 'deleted', "u"."deleted", 'htmlBio', COALESCE("u"."biography" ->> 'html', ''), 'postCount', "u"."postCount", 'commentCount', "u"."commentCount") END) AS "user", CASE WHEN "l"."_id" IS NULL THEN NULL ELSE JSONB_BUILD_OBJECT('_id', "l"."_id", 'name', "l"."name") END AS "localgroup" FROM "Notifications" AS "n" LEFT JOIN "Posts" AS "p" ON "n"."documentType" = 'post' AND "n"."documentId" = "p"."_id" LEFT JOIN "Revisions" AS "pr" ON "pr"."_id" = "p"."contents_latest" LEFT JOIN "Users" AS "pu" ON "p"."userId" = "pu"."_id" LEFT JOIN "Localgroups" AS "pl" ON "p"."groupId" = "pl"."_id" LEFT JOIN "Comments" AS "c" ON "n"."documentType" = 'comment' AND "n"."documentId" = "c"."_id" LEFT JOIN "Users" AS "cu" ON "c"."userId" = "cu"."_id" LEFT JOIN "Posts" AS "cp" ON "c"."postId" = "cp"."_id" LEFT JOIN "Revisions" AS "cpr" ON "cpr"."_id" = "cp"."contents_latest" LEFT JOIN "Users" AS "cpu" ON "cp"."userId" = "cpu"."_id" LEFT JOIN "Localgroups" AS "cpl" ON "cp"."groupId" = "cpl"."_id" LEFT JOIN "TagRels" AS "tr" ON "n"."documentType" = 'tagRel' AND "n"."documentId" = "tr"."_id" LEFT JOIN "Tags" AS "t" ON "t"."_id" = "tr"."tagId" LEFT JOIN "Posts" AS "trp" ON "trp"."_id" = "tr"."postId" LEFT JOIN "Revisions" AS "trpr" ON "trpr"."_id" = "trp"."contents_latest" LEFT JOIN "Users" AS "trpu" ON "trpu"."_id" = "trp"."userId" LEFT JOIN "Sequences" AS "s" ON "n"."documentType" = 'sequence' AND "n"."documentId" = "s"."_id" LEFT JOIN "Localgroups" AS "trpl" ON "trpl"."_id" = "trp"."groupId" LEFT JOIN "Users" AS "u" ON "n"."documentType" = 'user' AND "n"."documentId" = "u"."_id" LEFT JOIN "Localgroups" AS "l" ON "n"."documentType" = 'localgroup' AND "n"."documentId" = "l"."_id" LEFT JOIN "Users" AS "nma" ON "n"."extraData" ->> 'newMessageAuthorId' = "nma"."_id" WHERE "n"."userId" = $2::TEXT AND "n"."deleted" IS NOT TRUE AND "n"."emailed" IS NOT TRUE AND "n"."waitingForBatch" IS NOT TRUE AND (CASE WHEN $3::TEXT IS NULL THEN TRUE ELSE "n"."type" = $3 END) AND COALESCE("n"."documentType", '') <> 'message' AND NOT COALESCE("p"."deletedDraft", FALSE) AND NOT COALESCE("pu"."deleted", FALSE) AND NOT COALESCE("pl"."deleted", FALSE) AND NOT COALESCE("c"."deleted", FALSE) AND NOT COALESCE("cu"."deleted", FALSE) AND NOT COALESCE("cp"."deletedDraft", FALSE) AND NOT COALESCE("cpu"."deleted", FALSE) AND NOT COALESCE("cpl"."deleted", FALSE) AND NOT COALESCE("t"."deleted", FALSE) AND NOT COALESCE("u"."deleted", FALSE) AND NOT COALESCE("l"."deleted", FALSE) AND NOT COALESCE("s"."isDeleted", FALSE) AND NOT COALESCE("nma"."deleted", FALSE) ORDER BY "n"."createdAt" DESC LIMIT $4 OFFSET $5`;

export class NotificationsRepo {
  protected client: PostgresClient;

  constructor(client: PostgresClient) {
    this.client = client;
  }

  async notificationDisplays(
    params: INotificationDisplaysParams,
  ): Promise<INotificationDisplays[]> {
    const res: INotificationDisplays[] = await this.client.fetchRows(
      notificationDisplaysSql,
      [
        params.postSocialPreviewPrefix === undefined
          ? null
          : params.postSocialPreviewPrefix,
        params.userId === undefined ? null : params.userId,
        params.type === undefined ? null : params.type,
        params.limit === undefined ? null : params.limit,
        params.offset === undefined ? null : params.offset,
      ],
    );
    return res;
  }
}
