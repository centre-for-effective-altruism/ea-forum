import "server-only";
import type { Json, JsonRecord } from "./typeHelpers";
import type { EditorContents } from "./ckeditor/editorHelpers";
import type { VoteType } from "./votes/voteHelpers";
import { DenormalizedRevision } from "./revisions/revisionHelpers";
import { sql } from "drizzle-orm";
import {
  pgTable,
  index,
  uniqueIndex,
  unique,
  varchar,
  text,
  jsonb as jsonbRaw,
  integer,
  doublePrecision,
  boolean,
  pgMaterializedView,
  customType,
} from "drizzle-orm/pg-core";

/**
 * This file contains the postgres schemas for all tables.
 * This file must _ONLY_ export these schemas and types, and nothing else.
 */

/**
 * This is a custom timestamp type to meet our needs - _all_ time/date fields in
 * Postgres should use this type. This type always includes a timezone, and we
 * also automatically format the date from the custom format used by Postgres
 * to standard ISO8601 (this is required to, for instance, send the data to
 * elasticsearch without some complicated preprocessing).
 */
const timestamp = customType<{
  data: string;
  driverData: string;
}>({
  dataType() {
    return "timestamptz";
  },
  fromDriver(value: string): string {
    // Postgres: 2025-06-22 16:13:37.489301+00
    // ISO8601:  2025-06-22T16:13:37.489301Z
    return `${value.substring(0, 10)}T${value.substring(11, value.indexOf("+00"))}Z`;
  },
});

/**
 * Timestamp field with a default of the current time
 */
const timestampDefaultNow = () => timestamp().default(sql`CURRENT_TIMESTAMP`);

const jsonb = <T = Json>() => jsonbRaw().$type<T>();

const denormalizedRevision = () => jsonb<DenormalizedRevision>();

const universalFields = {
  _id: varchar({ length: 27 }).primaryKey().notNull(),
  schemaVersion: doublePrecision().default(1),
  createdAt: timestampDefaultNow().notNull(),
  legacyData: jsonb(),
};

// TODO: Add full users table - the drizzle parser chokes on the JSON default values
export const users = pgTable(
  "Users",
  {
    ...universalFields,
    username: text(),
    displayName: text().notNull(),
    previousDisplayName: text(),
    slug: text().notNull(),
    oldSlugs: text().array().default([""]).notNull(),
    profileImageId: text(),
    jobTitle: text(),
    organization: text(),
    careerStage: text().array(),
    website: text(),
    biography: denormalizedRevision(),
    biography_latest: text(),
    moderationGuidelines: denormalizedRevision(),
    moderationGuidelines_latest: text(),
    howOthersCanHelpMe: denormalizedRevision(),
    howOthersCanHelpMe_latest: text(),
    howICanHelpOthers: denormalizedRevision(),
    howICanHelpOthers_latest: text(),
    karma: doublePrecision().notNull().default(0),
    postCount: doublePrecision().notNull().default(0),
    maxPostCount: doublePrecision().notNull().default(0),
    frontpagePostCount: doublePrecision().notNull().default(0),
    commentCount: doublePrecision().notNull().default(0),
    maxCommentCount: doublePrecision().notNull().default(0),
    banned: timestamp(),
    services: jsonb<Record<string, Json>>(),
    isAdmin: boolean().notNull().default(false),
    theme: jsonb<{ name: "default" | "auto" | "dark" }>()
      .notNull()
      .default({ name: "default" }),
    hideIntercom: boolean().notNull().default(false),
    acceptedTos: boolean().notNull().default(false),
    hideNavigationSidebar: boolean(),
    hideHomeRHS: boolean().notNull().default(false),
    currentFrontpageFilter: text(),
    frontpageFilterSettings: jsonb(),
    lastNotificationsCheck: timestamp(),
    expandedFrontpageSections: jsonb(),
    email: text(),
    emails: jsonb<{ address: string; verified: boolean }[]>().array(),
    noindex: boolean().notNull().default(false),
    markDownPostEditor: boolean().notNull().default(false),
    groups: text().array(),
    conversationsDisabled: boolean(),
    mentionsDisabled: boolean().notNull().default(false),
    deleted: boolean().notNull().default(false),
    voteCount: doublePrecision(),
    smallUpvoteCount: doublePrecision(),
    smallDownvoteCount: doublePrecision(),
    bigUpvoteCount: doublePrecision(),
    bigDownvoteCount: doublePrecision(),
    voteReceivedCount: doublePrecision(),
    smallUpvoteReceivedCount: doublePrecision(),
    smallDownvoteReceivedCount: doublePrecision(),
    bigUpvoteReceivedCount: doublePrecision(),
    bigDownvoteReceivedCount: doublePrecision(),
    reviewedByUserId: varchar({ length: 27 }),
    hideCommunitySection: boolean().notNull().default(false),
    showCommunityInRecentDiscussion: boolean().notNull().default(false),
    needsReview: boolean().notNull().default(false),
    snoozedUntilContentCount: doublePrecision(),
    mapLocation: jsonb(),
    mongoLocation: jsonb<{ type: "Point"; coordinates: [number, number] }>(),
    googleLocation: jsonb(),
    location: text(),
    mapLocationSet: boolean(),
    usersContactedBeforeReview: text().array(),
    linkedinProfileURL: text(),
    facebookProfileURL: text(),
    blueskyProfileURL: text(),
    twitterProfileURL: text(),
    twitterProfileURLAdmin: text(),
    githubProfileURL: text(),
    profileTagIds: varchar({ length: 27 }).array().notNull().default([]),
    organizerOfGroupIds: varchar({ length: 27 }).array().notNull().default([]),
    programParticipation: text().array(),
    subscribedToDigest: boolean().notNull().default(false),
    hideSubscribePoke: boolean().notNull().default(false),
    unsubscribeFromAll: boolean(),
    shortformFeedId: varchar({ length: 27 }),

    /*
  "profile" JSONB,
  "lwWikiImport" BOOL,
  "lastUsedTimezone" TEXT,
  "whenConfirmationEmailSent" TIMESTAMPTZ,
  "legacy" BOOL NOT NULL DEFAULT FALSE,
  "commentSorting" TEXT,
  "sortDraftsBy" TEXT,
  "reactPaletteStyle" TEXT NOT NULL DEFAULT 'listView',
  "noKibitz" BOOL,
  "showHideKarmaOption" BOOL,
  "showPostAuthorCard" BOOL,
  "hideElicitPredictions" BOOL NOT NULL DEFAULT FALSE,
  "hideAFNonMemberInitialWarning" BOOL NOT NULL DEFAULT FALSE,
  "noSingleLineComments" BOOL NOT NULL DEFAULT FALSE,
  "noCollapseCommentsPosts" BOOL NOT NULL DEFAULT FALSE,
  "noCollapseCommentsFrontpage" BOOL NOT NULL DEFAULT FALSE,
  "hidePostsRecommendations" BOOL NOT NULL DEFAULT FALSE,
  "keywordAlerts" TEXT[] NOT NULL DEFAULT '{}',
  "petrovOptOut" BOOL NOT NULL DEFAULT FALSE,
  "optedOutOfSurveys" BOOL,
  "postGlossariesPinned" BOOL NOT NULL DEFAULT FALSE,
  "generateJargonForDrafts" BOOL NOT NULL DEFAULT FALSE,
  "generateJargonForPublishedPosts" BOOL NOT NULL DEFAULT TRUE,
  "frontpageSelectedTab" TEXT,
  "hideFrontpageFilterSettingsDesktop" BOOL,
  "allPostsTimeframe" TEXT,
  "allPostsFilter" TEXT,
  "allPostsSorting" TEXT,
  "allPostsShowLowKarma" BOOL,
  "allPostsIncludeEvents" BOOL,
  "allPostsHideCommunity" BOOL,
  "allPostsOpenSettings" BOOL,
  "draftsListSorting" TEXT,
  "draftsListShowArchived" BOOL,
  "draftsListShowShared" BOOL,
  "goodHeartTokens" DOUBLE PRECISION,
  "moderationStyle" TEXT,
  "moderatorAssistance" BOOL,
  "collapseModerationGuidelines" BOOL,
  "bannedUserIds" VARCHAR(27) [],
  "bannedPersonalUserIds" VARCHAR(27) [],
  "blockedUserIds" VARCHAR(27) [] NOT NULL DEFAULT '{}',
  "hiddenPostsMetadata" JSONB[] NOT NULL DEFAULT '{}',
  "legacyId" TEXT,
  "permanentDeletionRequestedAt" TIMESTAMPTZ,
  "voteBanned" BOOL,
  "nullifyVotes" BOOL,
  "deleteContent" BOOL,
  "auto_subscribe_to_my_posts" BOOL NOT NULL DEFAULT TRUE,
  "auto_subscribe_to_my_comments" BOOL NOT NULL DEFAULT TRUE,
  "autoSubscribeAsOrganizer" BOOL NOT NULL DEFAULT TRUE,
  "notificationCommentsOnSubscribedPost" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationShortformContent" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationRepliesToMyComments" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationRepliesToSubscribedComments" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSubscribedUserPost" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSubscribedUserComment" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationPostsInGroups" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSubscribedTagPost" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSubscribedSequencePost" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationPrivateMessage" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSharedWithMe" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationAlignmentSubmissionApproved" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationEventInRadius" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationKarmaPowersGained" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationRSVPs" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationGroupAdministration" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationCommentsOnDraft" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationPostsNominatedReview" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationSubforumUnread" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"daily","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationNewMention" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationNewPingback" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationDialogueMessages" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationPublishedDialogueMessages" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationAddedAsCoauthor" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationKeywordAlert" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationDebateCommentsOnSubscribedPost" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"daily","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationDebateReplies" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationDialogueMatch" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationNewDialogueChecks" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "notificationYourTurnMatchForm" JSONB NOT NULL DEFAULT '{"onsite":{"enabled":true,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"},"email":{"enabled":false,"batchingFrequency":"realtime","timeOfDayGMT":12,"dayOfWeekGMT":"Monday"}}'::JSONB,
  "hideDialogueFacilitation" BOOL NOT NULL DEFAULT FALSE,
  "revealChecksToAdmins" BOOL NOT NULL DEFAULT FALSE,
  "optedInToDialogueFacilitation" BOOL NOT NULL DEFAULT FALSE,
  "showDialoguesList" BOOL NOT NULL DEFAULT TRUE,
  "showMyDialogues" BOOL NOT NULL DEFAULT TRUE,
  "showMatches" BOOL NOT NULL DEFAULT TRUE,
  "showRecommendedPartners" BOOL NOT NULL DEFAULT TRUE,
  "hideActiveDialogueUsers" BOOL NOT NULL DEFAULT FALSE,
  "karmaChangeNotifierSettings" JSONB NOT NULL DEFAULT '{"updateFrequency":"daily","timeOfDayGMT":11,"dayOfWeekGMT":"Saturday","showNegativeKarma":false}'::JSONB,
  "karmaChangeLastOpened" TIMESTAMPTZ,
  "karmaChangeBatchStart" TIMESTAMPTZ,
  "emailSubscribedToCurated" BOOL,
  "sendInactiveSummaryEmail" BOOL NOT NULL DEFAULT TRUE,
  "sendMarketingEmails" BOOL NOT NULL DEFAULT TRUE,
  "subscribedToNewsletter" BOOL NOT NULL DEFAULT FALSE,
  "hideMeetupsPoke" BOOL NOT NULL DEFAULT FALSE,
  "sequenceCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "sequenceDraftCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "mapMarkerText" TEXT,
  "htmlMapMarkerText" TEXT,
  "nearbyEventsNotifications" BOOL NOT NULL DEFAULT FALSE,
  "nearbyEventsNotificationsLocation" JSONB,
  "nearbyEventsNotificationsMongoLocation" JSONB,
  "nearbyEventsNotificationsRadius" DOUBLE PRECISION,
  "nearbyPeopleNotificationThreshold" DOUBLE PRECISION,
  "hideFrontpageMap" BOOL,
  "hideTaggingProgressBar" BOOL,
  "hideFrontpageBookAd" BOOL,
  "hideFrontpageBook2019Ad" BOOL,
  "hideFrontpageBook2020Ad" BOOL,
  "sunshineNotes" TEXT NOT NULL DEFAULT '',
  "sunshineFlagged" BOOL NOT NULL DEFAULT FALSE,
  "sunshineSnoozed" BOOL NOT NULL DEFAULT FALSE,
  "reviewedByUserId" VARCHAR(27),
  "reviewedAt" TIMESTAMPTZ,
  "afKarma" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "fullName" TEXT,
  "viewUnreviewedComments" BOOL,
  "partiallyReadSequences" JSONB[],
  "beta" BOOL,
  "reviewVotesQuadratic" BOOL,
  "reviewVotesQuadratic2019" BOOL,
  "reviewVotesQuadratic2020" BOOL,
  "petrovPressedButtonDate" TIMESTAMPTZ,
  "petrovLaunchCodeDate" TIMESTAMPTZ,
  "defaultToCKEditor" BOOL,
  "signUpReCaptchaRating" DOUBLE PRECISION,
  "noExpandUnreadCommentsReview" BOOL NOT NULL DEFAULT FALSE,
  "tagRevisionCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "abTestKey" TEXT NOT NULL,
  "abTestOverrides" JSONB,
  "walledGardenInvite" BOOL,
  "hideWalledGardenUI" BOOL,
  "walledGardenPortalOnboarded" BOOL,
  "taggingDashboardCollapsed" BOOL,
  "usernameUnset" BOOL NOT NULL DEFAULT FALSE,
  "paymentEmail" TEXT,
  "paymentInfo" TEXT,
  "profileUpdatedAt" TIMESTAMPTZ NOT NULL DEFAULT '1970-01-01T00:00:00.000Z',
  "fmCrosspostUserId" TEXT,
  "postingDisabled" BOOL,
  "allCommentingDisabled" BOOL,
  "commentingOnOtherUsersDisabled" BOOL,
  "acknowledgedNewUserGuidelines" BOOL,
  "subforumPreferredLayout" TEXT,
  "hideJobAdUntil" TIMESTAMPTZ,
  "criticismTipsDismissed" BOOL NOT NULL DEFAULT FALSE,
  "hideFromPeopleDirectory" BOOL NOT NULL DEFAULT FALSE,
  "allowDatadogSessionReplay" BOOL NOT NULL DEFAULT FALSE,
  "afPostCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "afCommentCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "afSequenceCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "afSequenceDraftCount" DOUBLE PRECISION NOT NULL DEFAULT 0,
  "reviewForAlignmentForumUserId" TEXT,
  "afApplicationText" TEXT,
  "afSubmittedApplication" BOOL,
  "hideSunshineSidebar" BOOL NOT NULL DEFAULT FALSE,
  "inactiveSurveyEmailSentAt" TIMESTAMPTZ,
  "userSurveyEmailSentAt" TIMESTAMPTZ,
  "inactiveSummaryEmailSentAt" TIMESTAMPTZ,
  "recommendationSettings" JSONB,
  "givingSeason2025DonatedFlair" BOOL NOT NULL DEFAULT FALSE,
  "givingSeason2025VotedFlair" BOOL NOT NULL DEFAULT FALSE
     */
  },
  () => [
    // TODO: User indices
  ],
);

export type User = typeof users.$inferSelect;
export type InsertUser = typeof users.$inferInsert;

export const bans = pgTable(
  "Bans",
  {
    ...universalFields,
    expirationDate: timestamp(),
    userId: varchar({ length: 27 }).notNull(),
    ip: text(),
    reason: text(),
    comment: text().default("").notNull(),
    properties: jsonb(),
  },
  (table) => [
    index("idx_Bans_ip").using("btree", table.ip.asc().nullsLast()),
    index("idx_Bans_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const bookmarks = pgTable(
  "Bookmarks",
  {
    // For some reason bookmarks doesn't have legacyData and schemaVersion
    // universal fields...
    _id: varchar({ length: 27 }).primaryKey().notNull(),
    createdAt: timestampDefaultNow().notNull(),
    documentId: text().notNull(),
    collectionName: text().notNull(),
    userId: varchar({ length: 27 }).notNull(),
    lastUpdated: timestamp().notNull(),
    active: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Bookmarks_userId_active_lastUpdated").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.active.asc().nullsLast(),
      table.lastUpdated.asc().nullsLast(),
    ),
    uniqueIndex("idx_Bookmarks_userId_documentId_collectionName").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
      table.collectionName.asc().nullsLast(),
    ),
  ],
);

export const chapters = pgTable(
  "Chapters",
  {
    ...universalFields,
    title: text(),
    subtitle: text(),
    number: doublePrecision(),
    sequenceId: varchar({ length: 27 }),
    postIds: varchar({ length: 27 }).array().default([""]).notNull(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
  },
  (table) => [
    index("idx_Chapters_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Chapters_sequenceId_number").using(
      "btree",
      table.sequenceId.asc().nullsLast(),
      table.number.asc().nullsLast(),
    ),
  ],
);

export const books = pgTable(
  "Books",
  {
    ...universalFields,
    postedAt: timestamp(),
    title: text(),
    subtitle: text(),
    collectionId: varchar({ length: 27 }).notNull(),
    number: doublePrecision(),
    postIds: varchar({ length: 27 }).array().default([]).notNull(),
    sequenceIds: varchar({ length: 27 }).array().default([]).notNull(),
    displaySequencesAsGrid: boolean(),
    hideProgressBar: boolean(),
    showChapters: boolean(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
    tocTitle: text(),
  },
  (table) => [
    index("idx_Books_collectionId").using(
      "btree",
      table.collectionId.asc().nullsLast(),
    ),
    index("idx_Books_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const ckEditorUserSessions = pgTable(
  "CkEditorUserSessions",
  {
    ...universalFields,
    documentId: text().notNull(),
    userId: text().notNull(),
    endedAt: timestamp(),
    endedBy: text(),
  },
  (table) => [
    index("idx_CkEditorUserSessions_documentId_userId").using(
      "btree",
      table.documentId.asc().nullsLast(),
      table.userId.asc().nullsLast(),
    ),
    index("idx_CkEditorUserSessions_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const collections = pgTable(
  "Collections",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    title: text().notNull(),
    slug: text().notNull(),
    gridImageId: text(),
    firstPageLink: text().notNull(),
    hideStartReadingButton: boolean(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
    noindex: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Collections_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Collections_slug").using("btree", table.slug.asc().nullsLast()),
  ],
);

export const comments = pgTable(
  "Comments",
  {
    ...universalFields,
    parentCommentId: varchar({ length: 27 }),
    topLevelCommentId: varchar({ length: 27 }),
    postedAt: timestamp().notNull(),
    author: text(),
    postId: varchar({ length: 27 }),
    tagId: varchar({ length: 27 }),
    tagCommentType: text()
      .default("DISCUSSION")
      .notNull()
      .$type<"SUBFORUM" | "DISCUSSION">(),
    subforumStickyPriority: doublePrecision(),
    userId: varchar({ length: 27 }).notNull(),
    userIP: text(),
    // userAgent: text(), // Unused
    // referrer: text(), // Unused
    authorIsUnreviewed: boolean().default(false).notNull(),
    answer: boolean().default(false).notNull(),
    parentAnswerId: varchar({ length: 27 }),
    directChildrenCount: doublePrecision().default(0).notNull(),
    descendentCount: doublePrecision().default(0).notNull(),
    shortform: boolean(),
    nominatedForReview: text(),
    reviewingForReview: text(),
    lastSubthreadActivity: timestamp(),
    postVersion: text(),
    promoted: boolean(),
    promotedByUserId: varchar({ length: 27 }),
    promotedAt: timestamp(),
    hideKarma: boolean(),
    legacy: boolean().default(false).notNull(),
    legacyId: text(),
    legacyPoll: boolean().default(false).notNull(),
    legacyParentId: text(),
    retracted: boolean().default(false).notNull(),
    deleted: boolean().default(false).notNull(),
    deletedPublic: boolean().default(false).notNull(),
    deletedReason: text(),
    deletedDate: timestamp(),
    deletedByUserId: varchar({ length: 27 }),
    spam: boolean().default(false).notNull(),
    repliesBlockedUntil: timestamp(),
    needsReview: boolean(),
    reviewedByUserId: varchar({ length: 27 }),
    hideAuthor: boolean().default(false).notNull(),
    moderatorHat: boolean().default(false).notNull(),
    hideModeratorHat: boolean(),
    isPinnedOnProfile: boolean().default(false).notNull(),
    title: varchar({ length: 500 }),
    af: boolean().default(false).notNull(),
    suggestForAlignmentUserIds: text().array().default([]).notNull(),
    reviewForAlignmentUserId: text(),
    afDate: timestamp(),
    moveToAlignmentUserId: varchar({ length: 27 }),
    agentFoundationsId: text(),
    schemaVersion: doublePrecision().default(1),
    createdAt: timestampDefaultNow(),
    legacyData: jsonb(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
    voteCount: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    score: doublePrecision().default(0).notNull(),
    inactive: boolean().default(false).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    pingbacks: jsonb(),
    relevantTagIds: varchar({ length: 27 }).array().default([]).notNull(),
    debateResponse: boolean(),
    rejected: boolean().default(false).notNull(),
    rejectedByUserId: varchar({ length: 27 }),
    modGPTAnalysis: text(),
    modGPTRecommendation: text(),
    rejectedReason: text(),
    shortformFrontpage: boolean().default(true).notNull(),
    originalDialogueId: varchar({ length: 27 }),
    forumEventId: varchar({ length: 27 }),
    forumEventMetadata: jsonb(),
    lastEditedAt: timestamp(),
    draft: boolean().default(false).notNull(),
  },
  (table) => [
    index("comments_shortform_recent_discussions_idx")
      .using(
        "btree",
        sql`COALESCE("topLevelCommentId", _id)`,
        sql`"lastSubthreadActivity"`,
      )
      .where(sql`(shortform IS TRUE)`),
    index("idx_Comments_agentFoundationsId").using(
      "btree",
      table.agentFoundationsId.asc().nullsLast(),
    ),
    index("idx_Comments_inactive_postedAt").using(
      "btree",
      table.inactive.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Comments_isPinnedOnProfile_postedAt_authorIsUnreviewed_dele").using(
      "btree",
      table.isPinnedOnProfile.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_Comments_legacyId").using("btree", table.legacyId.asc().nullsLast()),
    index("idx_Comments_parentAnswerId_baseScore_authorIsUnreviewed_delete").using(
      "btree",
      table.parentAnswerId.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_Comments_parentCommentId").using(
      "btree",
      table.parentCommentId.asc().nullsLast(),
    ),
    index("idx_Comments_postId").using("btree", table.postId.asc().nullsLast()),
    index("idx_Comments_postId_promotedAt")
      .using(
        "btree",
        table.postId.asc().nullsLast(),
        table.promotedAt.asc().nullsLast(),
      )
      .where(sql`("promotedAt" IS NOT NULL)`),
    index("idx_Comments_postedAt_authorIsUnreviewed_deleted_deletedPublic_").using(
      "btree",
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_Comments_rejected_authorIsUnreviewed_postedAt_deleted_delet").using(
      "btree",
      table.rejected.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_Comments_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Comments_shortform_topLevelCommentId_lastSubthreadActivity_").using(
      "btree",
      table.shortform.asc().nullsLast(),
      table.topLevelCommentId.asc().nullsLast(),
      table.lastSubthreadActivity.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_Comments_suggestForAlignmentUserIds")
      .using(
        "btree",
        table.reviewForAlignmentUserId.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
      )
      .where(sql`("suggestForAlignmentUserIds" IS DISTINCT FROM '{}'::text[])`)
      .with({ deduplicate_items: "true" }),
    index("idx_Comments_topLevelCommentId").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
    ),
    index("idx_Comments_topLevelCommentId_postedAt_baseScore").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_Comments_topLevelCommentId_tagCommentType_tagId_authorIsUnr").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
      table.tagCommentType.asc().nullsLast(),
      table.tagId.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_Comments_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Comments_userId_isPinnedOnProfile_postedAt_authorIsUnreview").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.isPinnedOnProfile.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_Comments_userId_postId_postedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Comments_userId_postedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Comments_userId_postedAt_authorIsUnreviewed_deleted_deleted").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_af_top_comments").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.parentAnswerId.asc().nullsLast(),
      table.answer.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.afBaseScore.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_agentFoundationsId").using(
      "btree",
      table.agentFoundationsId.asc().nullsLast(),
    ),
    index("idx_comments_alignmentSuggestedComments")
      .using(
        "gin",
        table.reviewForAlignmentUserId.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.suggestForAlignmentUserIds.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.deleted.asc().nullsLast(),
        table.deletedPublic.asc().nullsLast(),
        table.hideAuthor.asc().nullsLast(),
        table.userId.asc().nullsLast(),
      )
      .where(sql`("suggestForAlignmentUserIds"[0] IS NOT NULL)`),
    index("idx_comments_forumEventId_userId_postedAt_authorIsUnreviewed_de").using(
      "btree",
      table.forumEventId.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_inactive_postedAt").using(
      "btree",
      table.inactive.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_comments_legacyId").using("btree", table.legacyId.asc().nullsLast()),
    index("idx_comments_magic_comments").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.parentAnswerId.asc().nullsLast(),
      table.answer.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.score.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_moderatorHat").using(
      "btree",
      table.moderatorHat.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_new_comments").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.parentAnswerId.asc().nullsLast(),
      table.answer.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_nominations2018").using(
      "btree",
      table.nominatedForReview.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_parentAnswerId_baseScore_authorIsUnreviewed_delete").using(
      "btree",
      table.parentAnswerId.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_parentCommentId").using(
      "btree",
      table.parentCommentId.asc().nullsLast(),
    ),
    index("idx_comments_popular_comments")
      .using(
        "btree",
        table.postId.asc().nullsLast(),
        table.baseScore.desc().nullsFirst(),
        table.postedAt.desc().nullsFirst(),
      )
      .where(sql`("baseScore" >= (15)::double precision)`),
    index("idx_comments_postId").using("btree", table.postId.asc().nullsLast()),
    index("idx_comments_postedAt_authorIsUnreviewed_deleted_deletedPublic_").using(
      "btree",
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_recent_replies").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.parentAnswerId.asc().nullsLast(),
      table.answer.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.lastSubthreadActivity.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_rejected_authorIsUnreviewed_postedAt_deleted_delet").using(
      "btree",
      table.rejected.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_reviews2018").using(
      "btree",
      table.reviewingForReview.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_comments_shortform_topLevelCommentId_lastSubthreadActivity_").using(
      "btree",
      table.shortform.asc().nullsLast(),
      table.topLevelCommentId.asc().nullsLast(),
      table.lastSubthreadActivity.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_comments_tagId").using(
      "btree",
      table.tagId.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_topLevelCommentId").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
    ),
    index("idx_comments_topLevelCommentId_postedAt_baseScore").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_comments_topLevelCommentId_tagCommentType_tagId_authorIsUnr").using(
      "btree",
      table.topLevelCommentId.asc().nullsLast(),
      table.tagCommentType.asc().nullsLast(),
      table.tagId.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_top_comments").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.parentAnswerId.asc().nullsLast(),
      table.answer.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.af.asc().nullsLast(),
    ),
    index("idx_comments_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_comments_userId_isPinnedOnProfile_postedAt_authorIsUnreview").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.isPinnedOnProfile.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
    index("idx_comments_userId_postedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_comments_userId_postedAt_authorIsUnreviewed_deleted_deleted").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.deletedPublic.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.debateResponse.asc().nullsLast(),
    ),
  ],
);

export type Comment = typeof comments.$inferSelect;
export type InsertComment = typeof comments.$inferInsert;

export const clientIds = pgTable(
  "ClientIds",
  {
    ...universalFields,
    clientId: text().notNull(),
    firstSeenReferrer: text(),
    firstSeenLandingPage: text(),
    userIds: text().array().default([""]),
    invalidated: boolean().default(false).notNull(),
    lastSeenAt: timestamp(),
    timesSeen: doublePrecision().default(1).notNull(),
  },
  (table) => [
    index("idx_ClientIds_clientId").using("btree", table.clientId.asc().nullsLast()),
    index("idx_ClientIds_createdAt").using(
      "btree",
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_ClientIds_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_ClientIds_userIds").using("gin", table.userIds.asc().nullsLast()),
    uniqueIndex("idx_idx_ClientIds_clientId_unique").using(
      "btree",
      table.clientId.asc().nullsLast(),
    ),
  ],
);

export const commentModeratorActions = pgTable(
  "CommentModeratorActions",
  {
    ...universalFields,
    commentId: varchar({ length: 27 }).notNull(),
    type: text().notNull(),
    endedAt: timestamp(),
  },
  (table) => [
    index("idx_CommentModeratorActions_commentId_createdAt").using(
      "btree",
      table.commentId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_CommentModeratorActions_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export type ModeratorAction = typeof moderatorActions.$inferSelect;

export const databaseMetadata = pgTable(
  "DatabaseMetadata",
  {
    ...universalFields,
    name: text().notNull(),
    value: jsonb().notNull(),
  },
  (table) => [
    uniqueIndex("idx_DatabaseMetadata_name").using(
      "btree",
      table.name.asc().nullsLast(),
    ),
    index("idx_DatabaseMetadata_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const digestPosts = pgTable(
  "DigestPosts",
  {
    ...universalFields,
    digestId: varchar({ length: 27 }).notNull(),
    postId: varchar({ length: 27 }).notNull(),
    emailDigestStatus: text(),
    onsiteDigestStatus: text(),
  },
  (table) => [
    index("idx_DigestPosts_digestId").using(
      "btree",
      table.digestId.asc().nullsLast(),
    ),
    index("idx_DigestPosts_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const curationNotices = pgTable(
  "CurationNotices",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    commentId: varchar({ length: 27 }),
    postId: varchar({ length: 27 }),
    deleted: boolean().default(false).notNull(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
  },
  (table) => [
    index("idx_CurationNotices_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const electionCandidates = pgTable(
  "ElectionCandidates",
  {
    ...universalFields,
    electionName: text().notNull(),
    name: text().notNull(),
    logoSrc: text().notNull(),
    href: text().notNull(),
    description: text().notNull(),
    userId: varchar({ length: 27 }).notNull(),
    postCount: doublePrecision().default(0).notNull(),
    voteCount: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    score: doublePrecision().default(0).notNull(),
    inactive: boolean().default(false).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    tagId: varchar({ length: 27 }).notNull(),
    fundraiserLink: text(),
    gwwcLink: text(),
    gwwcId: text(),
    amountRaised: doublePrecision(),
    targetAmount: doublePrecision(),
    isElectionFundraiser: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_ElectionCandidates_electionName").using(
      "btree",
      table.electionName.asc().nullsLast(),
    ),
    index("idx_ElectionCandidates_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const digests = pgTable(
  "Digests",
  {
    ...universalFields,
    num: doublePrecision().notNull(),
    startDate: timestamp().notNull(),
    endDate: timestamp(),
    publishedDate: timestamp(),
    onsiteImageId: text(),
    onsitePrimaryColor: text(),
    postId: varchar({ length: 27 }),
  },
  (table) => [
    index("idx_Digests_num").using("btree", table.num.asc().nullsLast()),
    index("idx_Digests_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const conversations = pgTable(
  "Conversations",
  {
    ...universalFields,
    title: text(),
    participantIds: varchar({ length: 27 }).array().default([]).notNull(),
    latestActivity: timestamp(),
    af: boolean(),
    messageCount: doublePrecision().default(0).notNull(),
    moderator: boolean(),
    archivedByIds: varchar({ length: 27 }).array().default([]).notNull(),
  },
  (table) => [
    index("idx_Conversations_moderator_messageCount_latestActivity_partici").using(
      "gin",
      table.moderator.asc().nullsLast(),
      table.messageCount.asc().nullsLast(),
      table.latestActivity.asc().nullsLast(),
      table.participantIds.asc().nullsLast(),
    ),
    index("idx_Conversations_participantIds_messageCount_latestActivity").using(
      "gin",
      table.participantIds.asc().nullsLast(),
      table.messageCount.asc().nullsLast(),
      table.latestActivity.asc().nullsLast(),
    ),
    index("idx_Conversations_participantIds_title").using(
      "gin",
      table.participantIds.asc().nullsLast(),
      table.title.asc().nullsLast(),
    ),
    index("idx_Conversations_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const debouncerEvents = pgTable(
  "DebouncerEvents",
  {
    ...universalFields,
    name: text().notNull(),
    af: boolean(),
    dispatched: boolean().notNull(),
    failed: boolean(),
    delayTime: timestamp().notNull(),
    upperBoundTime: timestamp().notNull(),
    key: text().notNull(),
    pendingEvents: text().array(),
  },
  (table) => [
    index("idx_DebouncerEvents_dispatched_af_delayTime").using(
      "btree",
      table.dispatched.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.delayTime.asc().nullsLast(),
    ),
    uniqueIndex("idx_DebouncerEvents_dispatched_af_key_name_filtered")
      .using(
        "btree",
        table.dispatched.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.key.asc().nullsLast(),
        table.name.asc().nullsLast(),
      )
      .where(sql`(dispatched IS FALSE)`),
    index("idx_DebouncerEvents_dispatched_af_upperBoundTime").using(
      "btree",
      table.dispatched.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.upperBoundTime.asc().nullsLast(),
    ),
    index("idx_DebouncerEvents_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const electionVotes = pgTable(
  "ElectionVotes",
  {
    ...universalFields,
    electionName: text().notNull(),
    userId: varchar({ length: 27 }),
    compareState: jsonb(),
    vote: jsonb(),
    submittedAt: timestamp(),
    userExplanation: text(),
    userOtherComments: text(),
    submissionComments: jsonb(),
  },
  (table) => [
    index("idx_ElectionVotes_electionName").using(
      "btree",
      table.electionName.asc().nullsLast(),
    ),
    uniqueIndex("idx_ElectionVotes_electionName_userId").using(
      "btree",
      sql`"electionName"`,
      sql`COALESCE("userId", ''::character varying)`,
    ),
    index("idx_ElectionVotes_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const curationEmails = pgTable(
  "CurationEmails",
  {
    ...universalFields,
    userId: text().notNull(),
    postId: text().notNull(),
  },
  (table) => [
    index("idx_CurationEmails_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    uniqueIndex("idx_CurationEmails_userId").using(
      "btree",
      table.userId.asc().nullsLast(),
    ),
  ],
);

export const fieldChanges = pgTable(
  "FieldChanges",
  {
    ...universalFields,
    userId: varchar({ length: 27 }),
    changeGroup: text(),
    documentId: text(),
    fieldName: text(),
    oldValue: jsonb(),
    newValue: jsonb(),
  },
  (table) => [
    index("idx_FieldChanges_documentId_createdAt").using(
      "btree",
      table.documentId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_FieldChanges_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_FieldChanges_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export const localgroups = pgTable(
  "Localgroups",
  {
    ...universalFields,
    name: text().notNull(),
    organizerIds: varchar({ length: 27 }).array().default([]).notNull(),
    lastActivity: timestamp().notNull(),
    types: text().array().default(["{LW}"]).notNull(),
    categories: text().array(),
    isOnline: boolean().default(false).notNull(),
    mongoLocation: jsonb<{ type: "Point"; coordinates: [number, number] }>(),
    googleLocation: jsonb<{
      geometry: { location: { lat: number; lng: number } };
    }>(),
    location: text(),
    contactInfo: text(),
    facebookLink: text(),
    facebookPageLink: text(),
    meetupLink: text(),
    slackLink: text(),
    website: text(),
    bannerImageId: text(),
    inactive: boolean().default(false).notNull(),
    deleted: boolean().default(false).notNull(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
    nameInAnotherLanguage: text(),
    salesforceId: text(),
  },
  (table) => [
    index("idx_Localgroups_inactive_deleted_name").using(
      "btree",
      table.inactive.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Localgroups_isOnline_inactive_deleted_name").using(
      "btree",
      table.isOnline.asc().nullsLast(),
      table.inactive.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Localgroups_mongoLocation_isOnline_inactive_deleted").using(
      "btree",
      table.mongoLocation.asc().nullsLast(),
      table.isOnline.asc().nullsLast(),
      table.inactive.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
    ),
    index("idx_Localgroups_organizerIds_deleted_name").using(
      "gin",
      table.organizerIds.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Localgroups_organizerIds_inactive_deleted").using(
      "gin",
      table.organizerIds.asc().nullsLast(),
      table.inactive.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
    ),
    index("idx_Localgroups_organizerIds_inactive_deleted_name").using(
      "gin",
      table.organizerIds.asc().nullsLast(),
      table.inactive.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Localgroups_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export type Localgroup = typeof localgroups.$inferSelect;

export const messages = pgTable(
  "Messages",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    conversationId: varchar({ length: 27 }).notNull(),
    noEmail: boolean().default(false).notNull(),
    contents: denormalizedRevision(),
    contentsLatest: text("contents_latest"),
  },
  (table) => [
    index("idx_Messages_conversationId_createdAt").using(
      "btree",
      table.conversationId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Messages_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const migrations = pgTable(
  "Migrations",
  {
    ...universalFields,
    name: text().notNull(),
    started: timestamp().notNull(),
    finished: boolean().default(false).notNull(),
    succeeded: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Migrations_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const moderatorActions = pgTable(
  "ModeratorActions",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    type: text().notNull(),
    endedAt: timestamp(),
  },
  (table) => [
    index("idx_ModeratorActions_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_ModeratorActions_type_createdAt_endedAt").using(
      "btree",
      table.type.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table.endedAt.asc().nullsLast(),
    ),
    index("idx_ModeratorActions_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export const emailTokens = pgTable(
  "EmailTokens",
  {
    ...universalFields,
    token: text().notNull(),
    tokenType: text().notNull(),
    userId: varchar({ length: 27 }).notNull(),
    usedAt: timestamp(),
    params: jsonb(),
  },
  (table) => [
    index("idx_EmailTokens_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_EmailTokens_token").using("btree", table.token.asc().nullsLast()),
  ],
);

export const lwEvents = pgTable(
  "LWEvents",
  {
    ...universalFields,
    userId: varchar({ length: 27 }),
    name: text(),
    documentId: text(),
    important: boolean(),
    properties: jsonb<JsonRecord>(),
    intercom: boolean(),
  },
  (table) => [
    index("idx_LWEvents_name_createdAt").using(
      "btree",
      table.name.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_LWEvents_name_properties__ip_createdAt_userId").using(
      "gin",
      sql`name`,
      sql`((properties -> 'ip'::text))`,
      sql`"createdAt"`,
      sql`"userId"`,
    ),
    index("idx_LWEvents_name_userId_createdAt").using(
      "btree",
      table.name.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_LWEvents_name_userId_documentId_createdAt").using(
      "btree",
      table.name.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_LWEvents_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("manual_idx__LWEvents_properties_ip")
      .using("gin", sql`((properties ->> 'ip'::text))`)
      .where(sql`(name = 'login'::text)`)
      .with({ fastupdate: "true" }),
  ],
);

export type LWEvent = typeof lwEvents.$inferSelect;
export type InsertLWEvent = typeof lwEvents.$inferInsert;

export const notifications = pgTable(
  "Notifications",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    documentId: text(),
    documentType: text(),
    extraData: jsonb(),
    link: text(),
    title: text(),
    message: text().notNull(),
    type: text().notNull(),
    deleted: boolean().default(false).notNull(),
    viewed: boolean().default(false).notNull(),
    emailed: boolean().default(false).notNull(),
    waitingForBatch: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Notifications_createdAt").using(
      "btree",
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Notifications_documentId").using(
      "btree",
      table.documentId.asc().nullsLast(),
    ),
    index("idx_Notifications_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Notifications_userId_emailed_waitingForBatch_createdAt_type").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.emailed.asc().nullsLast(),
      table.waitingForBatch.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table.type.asc().nullsLast(),
    ),
    index("idx_Notifications_userId_type_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.type.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export type Notification = typeof notifications.$inferSelect;

export const podcastEpisodes = pgTable(
  "PodcastEpisodes",
  {
    ...universalFields,
    podcastId: varchar({ length: 27 }).notNull(),
    title: text().notNull(),
    episodeLink: text().notNull(),
    externalEpisodeId: text().notNull(),
  },
  (table) => [
    uniqueIndex("idx_PodcastEpisodes_externalEpisodeId").using(
      "btree",
      table.externalEpisodeId.asc().nullsLast(),
    ),
    index("idx_PodcastEpisodes_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const images = pgTable(
  "Images",
  {
    ...universalFields,
    cdnHostedUrl: text().notNull(),
    originalUrl: text(),
    identifier: text().notNull(),
    identifierType: text().notNull(),
  },
  (table) => [
    index("idx_Images_cdnHostedUrl").using(
      "btree",
      table.cdnHostedUrl.asc().nullsLast(),
    ),
    index("idx_Images_identifier").using(
      "btree",
      table.originalUrl.asc().nullsLast(),
    ),
    index("idx_Images_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const forumEvents = pgTable(
  "ForumEvents",
  {
    ...universalFields,
    title: text().notNull(),
    startDate: timestamp().notNull(),
    endDate: timestamp(),
    darkColor: text().default("#000000").notNull(),
    lightColor: text().default("#ffffff").notNull(),
    tagId: varchar({ length: 27 }),
    bannerImageId: text(),
    frontpageDescription: denormalizedRevision(),
    frontpageDescriptionLatest: text("frontpageDescription_latest"),
    postPageDescription: denormalizedRevision(),
    postPageDescriptionLatest: text("postPageDescription_latest"),
    contrastColor: text(),
    includesPoll: boolean().default(false).notNull(),
    publicData: jsonb(),
    frontpageDescriptionMobile: denormalizedRevision(),
    frontpageDescriptionMobileLatest: text("frontpageDescriptionMobile_latest"),
    postId: varchar({ length: 27 }),
    customComponent: text(),
    textColor: text(),
    eventFormat: text().default("BASIC").notNull(),
    maxStickersPerUser: doublePrecision().default(1).notNull(),
    bannerTextColor: text().default("#ffffff").notNull(),
    commentPrompt: text(),
    pollQuestionLatest: text("pollQuestion_latest"),
    pollAgreeWording: text(),
    pollDisagreeWording: text(),
    isGlobal: boolean().default(true).notNull(),
    commentId: varchar({ length: 27 }),
    hideBanner: boolean().default(false).notNull(),
    stickerRequiresComment: boolean().default(true).notNull(),
  },
  (table) => [
    index("idx_ForumEvents_endDate").using("btree", table.endDate.asc().nullsLast()),
    index("idx_ForumEvents_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export type ForumEvent = typeof forumEvents.$inferSelect;
export type InsertForumEvent = typeof forumEvents.$inferInsert;

export const postViews = pgTable(
  "PostViews",
  {
    ...universalFields,
    updatedAt: timestamp().notNull(),
    windowStart: timestamp().notNull(),
    windowEnd: timestamp().notNull(),
    postId: varchar({ length: 27 }).notNull(),
    viewCount: doublePrecision().notNull(),
    uniqueViewCount: doublePrecision().notNull(),
  },
  (table) => [
    index("idx_PostViews_postId").using("btree", table.postId.asc().nullsLast()),
    uniqueIndex("idx_PostViews_postId_windowStart_windowEnd").using(
      "btree",
      table.postId.asc().nullsLast(),
      table.windowStart.asc().nullsLast(),
      table.windowEnd.asc().nullsLast(),
    ),
    index("idx_PostViews_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_PostViews_windowEnd").using(
      "btree",
      table.windowEnd.asc().nullsLast(),
    ),
    index("idx_PostViews_windowStart").using(
      "btree",
      table.windowStart.asc().nullsLast(),
    ),
  ],
);

export const postViewTimes = pgTable(
  "PostViewTimes",
  {
    ...universalFields,
    updatedAt: timestamp().notNull(),
    windowStart: timestamp().notNull(),
    windowEnd: timestamp().notNull(),
    clientId: varchar({ length: 27 }).notNull(),
    postId: varchar({ length: 27 }).notNull(),
    totalSeconds: doublePrecision().notNull(),
  },
  (table) => [
    uniqueIndex("idx_PostViewTimes_clientId_postId_windowStart_windowEnd").using(
      "btree",
      table.clientId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.windowStart.asc().nullsLast(),
      table.windowEnd.asc().nullsLast(),
    ),
    index("idx_PostViewTimes_postId").using("btree", table.postId.asc().nullsLast()),
    index("idx_PostViewTimes_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_PostViewTimes_windowEnd").using(
      "btree",
      table.windowEnd.asc().nullsLast(),
    ),
    index("idx_PostViewTimes_windowStart").using(
      "btree",
      table.windowStart.asc().nullsLast(),
    ),
  ],
);

export const podcasts = pgTable(
  "Podcasts",
  {
    ...universalFields,
    title: text().notNull(),
    applePodcastLink: text(),
    spotifyPodcastLink: text(),
  },
  (table) => [
    index("idx_Podcasts_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const postRecommendations = pgTable(
  "PostRecommendations",
  {
    ...universalFields,
    userId: varchar({ length: 27 }),
    clientId: text(),
    postId: varchar({ length: 27 }).notNull(),
    strategyName: text().notNull(),
    strategySettings: jsonb(),
    recommendationCount: integer().default(0).notNull(),
    lastRecommendedAt: timestamp().notNull(),
    clickedAt: timestamp(),
  },
  (table) => [
    index("idx_PostRecommendations_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    uniqueIndex("idx_PostRecommendations_userId_clientId_postId").using(
      "btree",
      sql`COALESCE("userId", ''::character varying)`,
      sql`COALESCE("clientId", ''::text)`,
      sql`"postId"`,
    ),
  ],
);

export const postRelations = pgTable(
  "PostRelations",
  {
    ...universalFields,
    type: text().notNull(),
    sourcePostId: varchar({ length: 27 }).notNull(),
    targetPostId: varchar({ length: 27 }).notNull(),
    order: doublePrecision(),
  },
  (table) => [
    index("idx_PostRelations_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_PostRelations_sourcePostId_order_createdAt").using(
      "btree",
      table.sourcePostId.asc().nullsLast(),
      table.order.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export const posts = pgTable(
  "Posts",
  {
    ...universalFields,
    postedAt: timestamp().notNull(),
    modifiedAt: timestamp(),
    url: varchar({ length: 500 }),
    title: varchar({ length: 500 }).notNull(),
    slug: text().notNull(),
    viewCount: doublePrecision().default(0).notNull(),
    lastCommentedAt: timestamp(),
    lastCommentReplyAt: timestamp(),
    clickCount: doublePrecision().default(0).notNull(),
    deletedDraft: boolean().default(false).notNull(),
    status: doublePrecision().notNull(),
    isFuture: boolean().notNull(),
    sticky: boolean().default(false).notNull(),
    stickyPriority: integer().default(2).notNull(),
    userIP: text(),
    userAgent: text(),
    referrer: text(),
    author: text(),
    userId: varchar({ length: 27 }).notNull(),
    question: boolean().default(false).notNull(),
    authorIsUnreviewed: boolean().default(false).notNull(),
    readTimeMinutesOverride: doublePrecision(),
    submitToFrontpage: boolean().default(true).notNull(),
    hiddenRelatedQuestion: boolean().default(false).notNull(),
    originalPostRelationSourceId: text(),
    shortform: boolean().default(false).notNull(),
    canonicalSource: text(),
    nominationCount2018: doublePrecision().default(0).notNull(),
    nominationCount2019: doublePrecision().default(0).notNull(),
    reviewCount2018: doublePrecision().default(0).notNull(),
    reviewCount2019: doublePrecision().default(0).notNull(),
    reviewCount: doublePrecision().default(0).notNull(),
    reviewVoteCount: doublePrecision().default(0).notNull(),
    positiveReviewVoteCount: doublePrecision().default(0).notNull(),
    reviewVoteScoreAF: doublePrecision().default(0).notNull(),
    reviewVotesAF: doublePrecision().array().default([]).notNull(),
    reviewVoteScoreHighKarma: doublePrecision().default(0).notNull(),
    reviewVotesHighKarma: doublePrecision().array().default([]).notNull(),
    reviewVoteScoreAllKarma: doublePrecision().default(0).notNull(),
    reviewVotesAllKarma: doublePrecision().array().default([]).notNull(),
    finalReviewVoteScoreHighKarma: doublePrecision().default(0).notNull(),
    finalReviewVotesHighKarma: doublePrecision().array().default([]).notNull(),
    finalReviewVoteScoreAllKarma: doublePrecision().default(0).notNull(),
    finalReviewVotesAllKarma: doublePrecision().array().default([]).notNull(),
    finalReviewVoteScoreAF: doublePrecision().default(0).notNull(),
    finalReviewVotesAF: doublePrecision().array().default([]).notNull(),
    lastCommentPromotedAt: timestamp(),
    tagRelevance: jsonb<Record<string, number>>(),
    noIndex: boolean().default(false).notNull(),
    rsvps: jsonb().array(),
    activateRSVPs: boolean(),
    nextDayReminderSent: boolean().default(false).notNull(),
    onlyVisibleToLoggedIn: boolean().default(false).notNull(),
    onlyVisibleToEstablishedAccounts: boolean().default(false).notNull(),
    hideFromRecentDiscussions: boolean().default(false).notNull(),
    votingSystem: text().default("twoAxis"),
    podcastEpisodeId: varchar({ length: 27 }),
    legacy: boolean().default(false).notNull(),
    legacyId: text(),
    legacySpam: boolean().default(false).notNull(),
    feedId: varchar({ length: 27 }),
    feedLink: text(),
    curatedDate: timestamp(),
    metaDate: timestamp(),
    suggestForCuratedUserIds: varchar({ length: 27 }).array(),
    frontpageDate: timestamp(),
    collectionTitle: text(),
    coauthorStatuses: jsonb().array(),
    hasCoauthorPermission: boolean().default(true).notNull(),
    socialPreviewImageId: text(),
    socialPreviewImageAutoUrl: text(),
    fmCrosspost: jsonb().default({ isCrosspost: false }).notNull(),
    canonicalSequenceId: varchar({ length: 27 }),
    canonicalCollectionSlug: text(),
    canonicalBookId: varchar({ length: 27 }),
    canonicalNextPostSlug: text(),
    canonicalPrevPostSlug: text(),
    unlisted: boolean().default(false).notNull(),
    disableRecommendation: boolean().default(false).notNull(),
    defaultRecommendation: boolean().default(false).notNull(),
    draft: boolean().default(false).notNull(),
    meta: boolean().default(false).notNull(),
    hideFrontpageComments: boolean().default(false).notNull(),
    maxBaseScore: doublePrecision().notNull(),
    scoreExceeded2Date: timestamp(),
    scoreExceeded30Date: timestamp(),
    scoreExceeded45Date: timestamp(),
    scoreExceeded75Date: timestamp(),
    scoreExceeded125Date: timestamp(),
    scoreExceeded200Date: timestamp(),
    bannedUserIds: varchar({ length: 27 }).array(),
    commentsLocked: boolean(),
    commentsLockedToAccountsCreatedAfter: timestamp(),
    organizerIds: varchar({ length: 27 }).array().default([]).notNull(),
    groupId: varchar({ length: 27 }),
    eventType: text(),
    isEvent: boolean().default(false).notNull(),
    reviewedByUserId: varchar({ length: 27 }),
    reviewForCuratedUserId: varchar({ length: 27 }),
    startTime: timestamp(),
    localStartTime: timestamp(),
    endTime: timestamp(),
    localEndTime: timestamp(),
    eventRegistrationLink: text(),
    joinEventLink: text(),
    onlineEvent: boolean().default(false).notNull(),
    globalEvent: boolean().default(false).notNull(),
    mongoLocation: jsonb(),
    googleLocation: jsonb(),
    location: text(),
    contactInfo: text(),
    facebookLink: text(),
    meetupLink: text(),
    website: text(),
    eventImageId: text(),
    types: text().array(),
    metaSticky: boolean().default(false).notNull(),
    sharingSettings: jsonb(),
    shareWithUsers: varchar({ length: 27 }).array().default([]).notNull(),
    linkSharingKey: text(),
    linkSharingKeyUsedBy: varchar({ length: 27 }).array(),
    commentSortOrder: text(),
    hideAuthor: boolean().default(false).notNull(),
    sideCommentVisibility: text(),
    moderationStyle: text(),
    hideCommentKarma: boolean().default(false).notNull(),
    commentCount: doublePrecision().default(0).notNull(),
    subforumTagId: varchar({ length: 27 }),
    af: boolean().default(false).notNull(),
    afDate: timestamp(),
    afCommentCount: doublePrecision().default(0).notNull(),
    afLastCommentedAt: timestamp(),
    afSticky: boolean().default(false).notNull(),
    suggestForAlignmentUserIds: text().array().default([""]).notNull(),
    reviewForAlignmentUserId: text(),
    agentFoundationsId: text(),
    contentsLatest: text("contents_latest"),
    pingbacks: jsonb(),
    moderationGuidelinesLatest: text("moderationGuidelines_latest"),
    customHighlight: jsonb(),
    customHighlightLatest: text("customHighlight_latest"),
    voteCount: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    score: doublePrecision().default(0).notNull(),
    inactive: boolean().default(false).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    debate: boolean().default(false).notNull(),
    rejected: boolean().default(false).notNull(),
    rejectedByUserId: varchar({ length: 27 }),
    rejectedReason: text(),
    ignoreRateLimits: boolean(),
    socialPreview: jsonb(),
    topLevelCommentCount: doublePrecision().default(0).notNull(),
    postCategory: text().default("post").notNull(),
    forceAllowType3Audio: boolean().default(false).notNull(),
    hideFromPopularComments: boolean().default(false).notNull(),
    wasEverUndrafted: boolean().default(false).notNull(),
    collabEditorDialogue: boolean().default(false).notNull(),
    mostRecentPublishedDialogueResponseDate: timestamp(),
    manifoldReviewMarketId: text(),
    swrCachingEnabled: boolean().default(false).notNull(),
    disableSidenotes: boolean().default(false).notNull(),
    autoFrontpage: text(),
    generateDraftJargon: boolean().default(false).notNull(),
    coauthorUserIds: text().array().default([""]).notNull(),
    marginalFundingOrg: text(),
  },
  (table) => [
    index("idx_Posts_agentFoundationsId").using(
      "btree",
      table.agentFoundationsId.asc().nullsLast(),
    ),
    index("idx_Posts_debate").using("btree", table.debate.asc().nullsLast()),
    index("idx_Posts_defaultRecommendation").using(
      "btree",
      table.defaultRecommendation.asc().nullsLast(),
    ),
    index("idx_Posts_fmCrosspost__foreignPostId_postedAt").using(
      "gin",
      sql`(("fmCrosspost" -> 'foreignPostId'::text))`,
      sql`"postedAt"`,
    ),
    index("idx_Posts_fmCrosspost_postedAt").using(
      "gin",
      table.fmCrosspost.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Posts_inactive_postedAt").using(
      "btree",
      table.inactive.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Posts_isFuture_postedAt").using(
      "btree",
      table.isFuture.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Posts_legacyId").using("btree", table.legacyId.asc().nullsLast()),
    index("idx_Posts_max_postedAt_mostRecentPublishedDialogueResponseDate")
      .using(
        "btree",
        sql`GREATEST("postedAt", "mostRecentPublishedDialogueResponseDate")`,
      )
      .where(sql`("collabEditorDialogue" IS TRUE)`),
    index("idx_Posts_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Posts_slug").using("btree", table.slug.asc().nullsLast()),
    index("idx_Posts_status_isFuture_draft_unlisted_authorIsUnreviewed_hid").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.hideFrontpageComments.asc().nullsLast(),
      table.lastCommentedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.globalEvent.asc().nullsLast(),
      table.commentCount.asc().nullsLast(),
    ),
    index("idx_Posts_status_isFuture_draft_unlisted_shortform_hiddenRelate").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.rejected.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_Posts_tagRelevance").using(
      "gin",
      table.tagRelevance.asc().nullsLast(),
    ),
    index("idx_Posts_tagRelevance__$**").using(
      "gin",
      sql`(("tagRelevance" -> '$**'::text))`,
    ),
    index("idx_Posts_url_postedAt").using(
      "btree",
      table.url.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_Posts_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Posts_userId_postedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_2dsphere").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.mongoLocation.asc().nullsLast(),
      table.eventType.asc().nullsLast(),
      table.startTime.asc().nullsLast(),
      table.endTime.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_agentFoundationsId").using(
      "btree",
      table.agentFoundationsId.asc().nullsLast(),
    ),
    index("idx_posts_alignmentSuggestedPosts")
      .using(
        "gin",
        table.status.asc().nullsLast(),
        table.isFuture.asc().nullsLast(),
        table.draft.asc().nullsLast(),
        table.unlisted.asc().nullsLast(),
        table.shortform.asc().nullsLast(),
        table.hiddenRelatedQuestion.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.groupId.asc().nullsLast(),
        table.reviewForAlignmentUserId.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.suggestForAlignmentUserIds.asc().nullsLast(),
        table.createdAt.asc().nullsLast(),
        table._id.asc().nullsLast(),
        table.meta.asc().nullsLast(),
        table.isEvent.asc().nullsLast(),
        table.frontpageDate.asc().nullsLast(),
        table.curatedDate.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table.baseScore.asc().nullsLast(),
      )
      .where(sql`("suggestForAlignmentUserIds"[0] IS NOT NULL)`),
    index("idx_posts_coauthorStatuses_postedAt").using(
      "gin",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.coauthorStatuses.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_coauthorUserIds_postedAt").using(
      "gin",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.coauthorUserIds.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_community").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.sticky.asc().nullsLast(),
      table.score.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_curated")
      .using(
        "btree",
        table.status.asc().nullsLast(),
        table.isFuture.asc().nullsLast(),
        table.draft.asc().nullsLast(),
        table.unlisted.asc().nullsLast(),
        table.shortform.asc().nullsLast(),
        table.hiddenRelatedQuestion.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.groupId.asc().nullsLast(),
        table.sticky.asc().nullsLast(),
        table.curatedDate.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table._id.asc().nullsLast(),
        table.meta.asc().nullsLast(),
        table.isEvent.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.frontpageDate.asc().nullsLast(),
        table.baseScore.asc().nullsLast(),
      )
      .where(
        sql`("curatedDate" > '1970-01-01 00:00:00+00'::timestamp with time zone)`,
      ),
    index("idx_posts_defaultRecommendation").using(
      "btree",
      table.defaultRecommendation.asc().nullsLast(),
    ),
    index("idx_posts_events").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.globalEvent.asc().nullsLast(),
      table.onlineEvent.asc().nullsLast(),
      table.startTime.asc().nullsLast(),
      table.endTime.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_fmCrosspost__foreignPostId_postedAt").using(
      "gin",
      sql`(("fmCrosspost" -> 'foreignPostId'::text))`,
      sql`"postedAt"`,
    ),
    index("idx_posts_frontpage")
      .using(
        "btree",
        table.status.asc().nullsLast(),
        table.isFuture.asc().nullsLast(),
        table.draft.asc().nullsLast(),
        table.unlisted.asc().nullsLast(),
        table.shortform.asc().nullsLast(),
        table.hiddenRelatedQuestion.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.groupId.asc().nullsLast(),
        table.sticky.asc().nullsLast(),
        table.stickyPriority.asc().nullsLast(),
        table.score.asc().nullsLast(),
        table.frontpageDate.asc().nullsLast(),
        table._id.asc().nullsLast(),
        table.meta.asc().nullsLast(),
        table.isEvent.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.curatedDate.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table.baseScore.asc().nullsLast(),
      )
      .where(
        sql`("frontpageDate" > '1970-01-01 00:00:00+00'::timestamp with time zone)`,
      ),
    index("idx_posts_globalEvents").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.globalEvent.asc().nullsLast(),
      table.eventType.asc().nullsLast(),
      table.startTime.asc().nullsLast(),
      table.endTime.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_inactive_postedAt").using(
      "btree",
      table.inactive.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_isFuture_postedAt").using(
      "btree",
      table.isFuture.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_legacyId").using("btree", table.legacyId.asc().nullsLast()),
    index("idx_posts_nominatablePostsByVote").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_pingbackPosts").using(
      "gin",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.pingbacks.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_pingbacks").using("gin", table.pingbacks.asc().nullsLast()),
    index("idx_posts_positiveReviewVoteCount").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.positiveReviewVoteCount.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_positiveReviewVoteCountReviewCount").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.positiveReviewVoteCount.asc().nullsLast(),
      table.reviewCount.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_postedAt_baseScore").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
    ),
    index("idx_posts_postsWithBannedUsers").using(
      "gin",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.bannedUserIds.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_recentDiscussionThreadsList").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.lastCommentedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.hideFrontpageComments.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_recommendable").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.disableRecommendation.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_posts_score").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.score.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_slug").using("btree", table.slug.asc().nullsLast()),
    index("idx_posts_sort_by_topAdjusted")
      .using(
        "btree",
        table.status.asc().nullsLast(),
        table.isFuture.asc().nullsLast(),
        table.draft.asc().nullsLast(),
        table.unlisted.asc().nullsLast(),
        table.shortform.asc().nullsLast(),
        table.hiddenRelatedQuestion.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.groupId.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table.baseScore.asc().nullsLast(),
        table.maxBaseScore.asc().nullsLast(),
        table._id.asc().nullsLast(),
        table.meta.asc().nullsLast(),
        table.isEvent.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.frontpageDate.asc().nullsLast(),
        table.curatedDate.asc().nullsLast(),
      )
      .where(
        sql`((status = (2)::double precision) AND (draft = false) AND (unlisted = false) AND ("isFuture" = false) AND (shortform = false) AND ("authorIsUnreviewed" = false) AND ("hiddenRelatedQuestion" = false) AND ("isEvent" = false))`,
      ),
    index("idx_posts_status_isFuture_draft_unlisted_authorIsUnreviewed_hid").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.hideFrontpageComments.asc().nullsLast(),
      table.lastCommentedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.globalEvent.asc().nullsLast(),
      table.commentCount.asc().nullsLast(),
    ),
    index("idx_posts_status_isFuture_draft_unlisted_shortform_hiddenRelate").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.rejected.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_sunshineCuratedSuggestions")
      .using(
        "gin",
        table.status.asc().nullsLast(),
        table.isFuture.asc().nullsLast(),
        table.draft.asc().nullsLast(),
        table.unlisted.asc().nullsLast(),
        table.shortform.asc().nullsLast(),
        table.hiddenRelatedQuestion.asc().nullsLast(),
        table.authorIsUnreviewed.asc().nullsLast(),
        table.groupId.asc().nullsLast(),
        table.createdAt.asc().nullsLast(),
        table.reviewForCuratedUserId.asc().nullsLast(),
        table.suggestForCuratedUserIds.asc().nullsLast(),
        table._id.asc().nullsLast(),
        table.meta.asc().nullsLast(),
        table.isEvent.asc().nullsLast(),
        table.af.asc().nullsLast(),
        table.frontpageDate.asc().nullsLast(),
        table.curatedDate.asc().nullsLast(),
        table.postedAt.asc().nullsLast(),
        table.baseScore.asc().nullsLast(),
      )
      .where(sql`("suggestForCuratedUserIds" IS NOT NULL)`),
    index("idx_posts_sunshineNewPosts").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.reviewedByUserId.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_sunshineNewUsersPosts").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.reviewedByUserId.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_tagRelevance__$**").using(
      "gin",
      sql`(("tagRelevance" -> '$**'::text))`,
    ),
    index("idx_posts_topQuestions").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.question.asc().nullsLast(),
      table.lastCommentedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_url_postedAt").using(
      "btree",
      table.url.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_userId_createdAt").using(
      "btree",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.hideAuthor.asc().nullsLast(),
      table.deletedDraft.asc().nullsLast(),
      table.modifiedAt.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
    index("idx_posts_userId_postedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
    ),
    index("idx_posts_userId_shareWithUsers").using(
      "gin",
      table.status.asc().nullsLast(),
      table.isFuture.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.unlisted.asc().nullsLast(),
      table.shortform.asc().nullsLast(),
      table.hiddenRelatedQuestion.asc().nullsLast(),
      table.authorIsUnreviewed.asc().nullsLast(),
      table.groupId.asc().nullsLast(),
      table.shareWithUsers.asc().nullsLast(),
      table.deletedDraft.asc().nullsLast(),
      table.modifiedAt.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.meta.asc().nullsLast(),
      table.isEvent.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.frontpageDate.asc().nullsLast(),
      table.curatedDate.asc().nullsLast(),
      table.postedAt.asc().nullsLast(),
      table.baseScore.asc().nullsLast(),
    ),
  ],
);

export type Post = typeof posts.$inferSelect;
export type InsertPost = typeof posts.$inferInsert;

export const reports = pgTable(
  "Reports",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    reportedUserId: varchar({ length: 27 }),
    commentId: varchar({ length: 27 }),
    postId: varchar({ length: 27 }),
    link: text().notNull(),
    claimedUserId: varchar({ length: 27 }),
    description: text(),
    closedAt: timestamp(),
    markedAsSpam: boolean(),
    reportedAsSpam: boolean(),
  },
  (table) => [
    index("idx_Reports_claimedUserId_createdAt").using(
      "btree",
      table.claimedUserId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Reports_closedAt_createdAt").using(
      "btree",
      table.closedAt.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Reports_createdAt").using("btree", table.createdAt.asc().nullsLast()),
    index("idx_Reports_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const rssFeeds = pgTable(
  "RSSFeeds",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    ownedByUser: boolean().default(false).notNull(),
    displayFullContent: boolean().default(false).notNull(),
    nickname: text().notNull(),
    url: text().notNull(),
    status: text(),
    rawFeed: jsonb().notNull(),
    setCanonicalUrl: boolean().default(false).notNull(),
    importAsDraft: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_RSSFeeds_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_RSSFeeds_userId_createdAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export const tagRels = pgTable(
  "TagRels",
  {
    ...universalFields,
    tagId: varchar({ length: 27 }).notNull(),
    postId: varchar({ length: 27 }).notNull(),
    deleted: boolean().default(false).notNull(),
    userId: varchar({ length: 27 }),
    voteCount: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    score: doublePrecision().default(0).notNull(),
    inactive: boolean().default(false).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    backfilled: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_TagRels_postId").using("btree", table.postId.asc().nullsLast()),
    index("idx_TagRels_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_TagRels_tagId").using("btree", table.tagId.asc().nullsLast()),
  ],
);

export const subscriptions = pgTable(
  "Subscriptions",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    state: text().notNull(),
    documentId: text(),
    collectionName: text().notNull(),
    deleted: boolean().default(false).notNull(),
    type: text().notNull(),
  },
  (table) => [
    index("idx_Subscriptions_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Subscriptions_userId_documentId_collectionName_type_created").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
      table.collectionName.asc().nullsLast(),
      table.type.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
  ],
);

export const readStatuses = pgTable(
  "ReadStatuses",
  {
    ...universalFields,
    postId: varchar({ length: 27 }),
    tagId: varchar({ length: 27 }),
    userId: varchar({ length: 27 }).notNull(),
    isRead: boolean().notNull(),
    lastUpdated: timestamp().notNull(),
  },
  (table) => [
    index("idx_ReadStatuses_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_ReadStatuses_userId_postId_isRead_lastUpdated").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.isRead.asc().nullsLast(),
      table.lastUpdated.asc().nullsLast(),
    ),
    uniqueIndex("idx_ReadStatuses_userId_postId_tagId").using(
      "btree",
      sql`COALESCE("userId", ''::character varying)`,
      sql`COALESCE("postId", ''::character varying)`,
      sql`COALESCE("tagId", ''::character varying)`,
    ),
    index("idx_ReadStatuses_userId_tagId_isRead_lastUpdated").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.tagId.asc().nullsLast(),
      table.isRead.asc().nullsLast(),
      table.lastUpdated.asc().nullsLast(),
    ),
  ],
);

export const sessions = pgTable(
  "Sessions",
  {
    _id: varchar({ length: 27 }).primaryKey().notNull(),
    session: jsonb(),
    expires: timestamp(),
    lastModified: timestamp(),
  },
  (table) => [
    index("idx_Sessions__id_expires").using(
      "btree",
      table._id.asc().nullsLast(),
      table.expires.asc().nullsLast(),
    ),
    index("idx_Sessions_expires").using("btree", table.expires.asc().nullsLast()),
  ],
);

export const tagFlags = pgTable(
  "TagFlags",
  {
    ...universalFields,
    name: text().notNull(),
    deleted: boolean().default(false).notNull(),
    slug: text().notNull(),
    order: doublePrecision(),
    contents: jsonb(),
    contentsLatest: text("contents_latest"),
  },
  (table) => [
    index("idx_TagFlags_deleted_order_name").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.order.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_TagFlags_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const revisions = pgTable(
  "Revisions",
  {
    ...universalFields,
    documentId: text(),
    collectionName: text(),
    fieldName: text(),
    editedAt: timestamp(),
    autosaveTimeoutStart: timestamp(),
    updateType: text(),
    version: text().notNull(),
    commitMessage: text(),
    userId: varchar({ length: 27 }),
    draft: boolean(),
    originalContents: jsonb<EditorContents>(),
    html: text(),
    wordCount: doublePrecision().notNull(),
    changeMetrics: jsonb<{ added: number; removed: number }>().notNull(),
    voteCount: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    score: doublePrecision().default(0).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    googleDocMetadata: jsonb(),
    skipAttributions: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Revisions_collectionName_fieldName_editedAt__id_changeMetri").using(
      "btree",
      table.collectionName.asc().nullsLast(),
      table.fieldName.asc().nullsLast(),
      table.editedAt.asc().nullsLast(),
      table._id.asc().nullsLast(),
      table.changeMetrics.asc().nullsLast(),
    ),
    index("idx_Revisions_documentId_version_fieldName_editedAt").using(
      "btree",
      table.documentId.asc().nullsLast(),
      table.version.asc().nullsLast(),
      table.fieldName.asc().nullsLast(),
      table.editedAt.asc().nullsLast(),
    ),
    index("idx_Revisions_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Revisions_userId_collectionName_editedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.collectionName.asc().nullsLast(),
      table.editedAt.asc().nullsLast(),
    ),
  ],
);

export type Revision = typeof revisions.$inferSelect;
export type InsertRevision = typeof revisions.$inferInsert;

export const sequences = pgTable(
  "Sequences",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    title: text().notNull(),
    gridImageId: text(),
    bannerImageId: text(),
    curatedOrder: doublePrecision(),
    userProfileOrder: doublePrecision(),
    draft: boolean().default(false).notNull(),
    isDeleted: boolean().default(false).notNull(),
    canonicalCollectionSlug: text(),
    hidden: boolean().default(false).notNull(),
    hideFromAuthorPage: boolean().default(false).notNull(),
    af: boolean().default(false).notNull(),
    contents: jsonb(),
    contentsLatest: text("contents_latest"),
    noindex: boolean().default(false).notNull(),
    lastUpdated: timestamp().notNull(),
  },
  (table) => [
    index("idx_Sequences_hidden_af_isDeleted_curatedOrder").using(
      "btree",
      table.hidden.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.isDeleted.asc().nullsLast(),
      table.curatedOrder.asc().nullsLast(),
    ),
    index("idx_Sequences_hidden_af_isDeleted_userId_draft_hideFromAuthorPa").using(
      "btree",
      table.hidden.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.isDeleted.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.draft.asc().nullsLast(),
      table.hideFromAuthorPage.asc().nullsLast(),
      table.userProfileOrder.asc().nullsLast(),
    ),
    index("idx_Sequences_hidden_af_isDeleted_userId_userProfileOrder").using(
      "btree",
      table.hidden.asc().nullsLast(),
      table.af.asc().nullsLast(),
      table.isDeleted.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.userProfileOrder.asc().nullsLast(),
    ),
    index("idx_Sequences_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export type Sequence = typeof sequences.$inferSelect;

export const spotlights = pgTable(
  "Spotlights",
  {
    ...universalFields,
    documentId: text().notNull(),
    documentType: text().default("Sequence").notNull(),
    position: doublePrecision().notNull(),
    duration: doublePrecision().default(3).notNull(),
    customTitle: text(),
    customSubtitle: text(),
    lastPromotedAt: timestamp().default("'1970-01-01T00:00:00.000Z'").notNull(),
    draft: boolean().default(true).notNull(),
    spotlightImageId: text(),
    descriptionLatest: text("description_latest"),
    description: jsonb(),
    showAuthor: boolean().default(false).notNull(),
    spotlightDarkImageId: text(),
    imageFade: boolean().default(true).notNull(),
    headerTitle: text(),
    headerTitleLeftColor: text(),
    headerTitleRightColor: text(),
    imageFadeColor: text(),
    deletedDraft: boolean().default(false).notNull(),
    spotlightSplashImageUrl: text(),
    subtitleUrl: text(),
  },
  (table) => [
    index("idx_Spotlights_lastPromotedAt").using(
      "btree",
      table.lastPromotedAt.asc().nullsLast(),
    ),
    index("idx_Spotlights_position").using(
      "btree",
      table.position.asc().nullsLast(),
    ),
    index("idx_Spotlights_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export const userEagDetails = pgTable(
  "UserEAGDetails",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    careerStage: text().array(),
    countryOrRegion: text(),
    nearestCity: text(),
    willingnessToRelocate: jsonb(),
    experiencedIn: text().array(),
    interestedIn: text().array(),
    lastUpdated: timestamp().notNull(),
  },
  (table) => [
    index("idx_UserEAGDetails_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    uniqueIndex("idx_UserEAGDetails_userId").using(
      "btree",
      table.userId.asc().nullsLast(),
    ),
  ],
);

export const tweets = pgTable(
  "Tweets",
  {
    ...universalFields,
    postId: text().notNull(),
    tweetId: text().notNull(),
    content: text().notNull(),
  },
  (table) => [
    index("idx_Tweets_postId").using("btree", table.postId.asc().nullsLast()),
    index("idx_Tweets_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Tweets_tweetId").using("btree", table.tweetId.asc().nullsLast()),
  ],
);

export const userJobAds = pgTable(
  "UserJobAds",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    jobName: text().notNull(),
    adState: text().notNull(),
    lastUpdated: timestamp().notNull(),
    reminderSetAt: timestamp(),
  },
  (table) => [
    index("idx_UserJobAds_jobName_adState").using(
      "btree",
      table.jobName.asc().nullsLast(),
      table.adState.asc().nullsLast(),
    ),
    index("idx_UserJobAds_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_UserJobAds_userId").using("btree", table.userId.asc().nullsLast()),
    uniqueIndex("idx_UserJobAds_userId_jobName").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.jobName.asc().nullsLast(),
    ),
  ],
);

export const userActivities = pgTable(
  "UserActivities",
  {
    ...universalFields,
    visitorId: varchar({ length: 27 }).notNull(),
    type: text().notNull(),
    startDate: timestamp().notNull(),
    endDate: timestamp().notNull(),
    activityArray: doublePrecision().array().notNull(),
  },
  (table) => [
    index("idx_UserActivities_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_UserActivities_visitorId_type").using(
      "btree",
      table.visitorId.asc().nullsLast(),
      table.type.asc().nullsLast(),
    ),
    unique("UserActivities_visitorId_type_key").on(table.visitorId, table.type),
  ],
);

export const userRateLimits = pgTable(
  "UserRateLimits",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    type: text().notNull(),
    intervalUnit: text().notNull(),
    intervalLength: doublePrecision().notNull(),
    actionsPerInterval: doublePrecision().notNull(),
    endedAt: timestamp().notNull(),
  },
  (table) => [
    index("idx_UserRateLimits_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_UserRateLimits_userId_createdAt_endedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
      table.endedAt.asc().nullsLast(),
    ),
  ],
);

export type UserRateLimit = typeof userRateLimits.$inferSelect;

export const userTagRels = pgTable(
  "UserTagRels",
  {
    ...universalFields,
    tagId: varchar({ length: 27 }).notNull(),
    userId: varchar({ length: 27 }).notNull(),
    subforumLastVisitedAt: timestamp(),
    subforumShowUnreadInSidebar: boolean().default(true).notNull(),
    subforumEmailNotifications: boolean().default(false).notNull(),
    subforumHideIntroPost: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_UserTagRels_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    uniqueIndex("idx_UserTagRels_tagId_userId").using(
      "btree",
      sql`COALESCE("tagId", ''::character varying)`,
      sql`COALESCE("userId", ''::character varying)`,
    ),
  ],
);

export const userMostValuablePosts = pgTable(
  "UserMostValuablePosts",
  {
    ...universalFields,
    userId: varchar({ length: 27 }).notNull(),
    postId: varchar({ length: 27 }).notNull(),
    deleted: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_UserMostValuablePosts_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_UserMostValuablePosts_userId").using(
      "btree",
      table.userId.asc().nullsLast(),
    ),
    index("idx_UserMostValuablePosts_userId_deleted").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
    ),
    index("idx_UserMostValuablePosts_userId_postId").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
    ),
    index("idx_UserMostValuablePosts_userId_postId_deleted").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.postId.asc().nullsLast(),
      table.deleted.asc().nullsLast(),
    ),
  ],
);

export const tags = pgTable(
  "Tags",
  {
    ...universalFields,
    name: text().notNull(),
    slug: text().notNull(),
    oldSlugs: text().array().default([""]).notNull(),
    core: boolean().default(false).notNull(),
    suggestedAsFilter: boolean().default(false).notNull(),
    defaultOrder: doublePrecision().default(0).notNull(),
    descriptionTruncationCount: doublePrecision().default(0).notNull(),
    postCount: doublePrecision().default(0).notNull(),
    userId: varchar({ length: 27 }),
    adminOnly: boolean().default(false).notNull(),
    canEditUserIds: varchar({ length: 27 }).array(),
    charsAdded: doublePrecision(),
    charsRemoved: doublePrecision(),
    deleted: boolean().default(false).notNull(),
    lastCommentedAt: timestamp(),
    lastSubforumCommentAt: timestamp(),
    needsReview: boolean().default(true).notNull(),
    reviewedByUserId: varchar({ length: 27 }),
    wikiGrade: integer().default(2).notNull(),
    wikiOnly: boolean().default(false).notNull(),
    bannerImageId: text(),
    tagFlagsIds: varchar({ length: 27 }).array().default([]).notNull(),
    lesswrongWikiImportRevision: text(),
    lesswrongWikiImportSlug: text(),
    lesswrongWikiImportCompleted: boolean(),
    htmlWithContributorAnnotations: text(),
    contributionStats: jsonb(),
    introSequenceId: varchar({ length: 27 }),
    postsDefaultSortOrder: text(),
    canVoteOnRels: text().array(),
    isSubforum: boolean().default(false).notNull(),
    subforumModeratorIds: varchar({ length: 27 }).array().default([]).notNull(),
    parentTagId: varchar({ length: 27 }),
    autoTagModel: text(),
    autoTagPrompt: text(),
    descriptionLatest: text("description_latest"),
    subforumWelcomeTextLatest: text("subforumWelcomeText_latest"),
    moderationGuidelines: jsonb(),
    moderationGuidelinesLatest: text("moderationGuidelines_latest"),
    description: jsonb(),
    subforumWelcomeText: jsonb(),
    subTagIds: varchar({ length: 27 }).array().default([]).notNull(),
    subforumIntroPostId: varchar({ length: 27 }),
    shortName: text(),
    squareImageId: text(),
    subtitle: text(),
    noindex: boolean().default(false).notNull(),
    isPostType: boolean().default(false).notNull(),
    isPlaceholderPage: boolean().default(false).notNull(),
    pingbacks: jsonb(),
    voteCount: doublePrecision().default(0).notNull(),
    score: doublePrecision().default(0).notNull(),
    baseScore: doublePrecision().default(0).notNull(),
    extendedScore: jsonb(),
    inactive: boolean().default(false).notNull(),
    afBaseScore: doublePrecision(),
    afExtendedScore: jsonb(),
    afVoteCount: doublePrecision(),
    coreTagId: text(),
    forceAllowType3Audio: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Tags_deleted_adminOnly").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_lesswrongWikiImportSlug").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.lesswrongWikiImportSlug.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_name").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_suggestedAsFilter_defaultOrder_name").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.suggestedAsFilter.asc().nullsLast(),
      table.defaultOrder.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_tagFlagsIds").using(
      "gin",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.tagFlagsIds.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_wikiGrade_defaultOrder_postCount_nam").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.wikiGrade.asc().nullsLast(),
      table.defaultOrder.asc().nullsLast(),
      table.postCount.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_adminOnly_wikiOnly_createdAt").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.adminOnly.asc().nullsLast(),
      table.wikiOnly.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_core_name").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.core.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_createdAt").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_isPostType_name").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.isPostType.asc().nullsLast(),
      table.name.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_needsReview_createdAt").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.needsReview.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_slug_oldSlugs").using(
      "gin",
      table.deleted.asc().nullsLast(),
      table.slug.asc().nullsLast(),
      table.oldSlugs.asc().nullsLast(),
    ),
    index("idx_Tags_deleted_userId_createdAt").using(
      "btree",
      table.deleted.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.createdAt.asc().nullsLast(),
    ),
    index("idx_Tags_name").using("btree", table.name.asc().nullsLast()),
    index("idx_Tags_parentTagId").using(
      "btree",
      table.parentTagId.asc().nullsLast(),
    ),
    index("idx_Tags_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
  ],
);

export type Tag = typeof tags.$inferSelect;
export type InsertTag = typeof tags.$inferInsert;

export const votes = pgTable(
  "Votes",
  {
    ...universalFields,
    documentId: text().notNull(),
    collectionName: text().notNull(),
    userId: varchar({ length: 27 }).notNull(),
    authorIds: varchar({ length: 27 }).array(),
    voteType: text().$type<VoteType>().notNull(),
    extendedVoteType: jsonb(),
    power: doublePrecision().notNull(),
    afPower: doublePrecision(),
    cancelled: boolean().default(false).notNull(),
    isUnvote: boolean().default(false).notNull(),
    votedAt: timestamp().notNull(),
    documentIsAf: boolean().default(false).notNull(),
    silenceNotification: boolean().default(false).notNull(),
  },
  (table) => [
    index("idx_Votes_authorIds").using("gin", table.authorIds.asc().nullsLast()),
    index("idx_Votes_authorIds_votedAt_userId_afPower").using(
      "gin",
      table.authorIds.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.afPower.asc().nullsLast(),
    ),
    index("idx_Votes_cancelled_documentId").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
    ),
    index("idx_Votes_cancelled_userId_documentId").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
    ),
    index("idx_Votes_cancelled_userId_votedAt").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_Votes_collectionName_userId_voteType_cancelled_isUnvote_vot").using(
      "btree",
      table.collectionName.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.voteType.asc().nullsLast(),
      table.cancelled.asc().nullsLast(),
      table.isUnvote.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_Votes_collectionName_votedAt").using(
      "btree",
      table.collectionName.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_Votes_documentId").using("btree", table.documentId.asc().nullsLast()),
    index("idx_Votes_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_Votes_userId_cancelled_votedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.cancelled.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_votes_authorIds").using("gin", table.authorIds.asc().nullsLast()),
    index("idx_votes_cancelled_documentId").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
    ),
    index("idx_votes_cancelled_userId_documentId").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.documentId.asc().nullsLast(),
    ),
    index("idx_votes_cancelled_userId_votedAt").using(
      "btree",
      table.cancelled.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_votes_collectionName_userId_voteType_cancelled_isUnvote_vot").using(
      "btree",
      table.collectionName.asc().nullsLast(),
      table.userId.asc().nullsLast(),
      table.voteType.asc().nullsLast(),
      table.cancelled.asc().nullsLast(),
      table.isUnvote.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_votes_collectionName_votedAt").using(
      "btree",
      table.collectionName.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_votes_documentId").using("btree", table.documentId.asc().nullsLast()),
    index("idx_votes_schemaVersion").using(
      "btree",
      table.schemaVersion.asc().nullsLast(),
    ),
    index("idx_votes_userId_cancelled_votedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.cancelled.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
    index("idx_votes_userId_collectionName_cancelled_votedAt").using(
      "btree",
      table.userId.asc().nullsLast(),
      table.collectionName.asc().nullsLast(),
      table.cancelled.asc().nullsLast(),
      table.votedAt.asc().nullsLast(),
    ),
  ],
);

export type Vote = typeof votes.$inferSelect;
export type InsertVote = typeof votes.$inferInsert;

export const userLoginTokens = pgMaterializedView("UserLoginTokens").as((qb) =>
  qb
    .select({
      hashedToken: sql`
          JSONB_ARRAY_ELEMENTS(
            ${users.services}->'resume'->'loginTokens'
          )->>'hashedToken'
        `.as("hashedToken"),
      userId: users._id.as("userId"),
    })
    .from(users)
    .where(sql`JSONB_TYPEOF(${users.services}->'resume'->'loginTokens') = 'array'`),
);
